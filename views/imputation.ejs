<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Merging</title>
  <%- include(process.cwd() +"/views/common/link.html") %>
  <link rel="stylesheet" href="../static/css/collapse.css" type="text/css">
  <link rel="stylesheet" href="../static/css/onoff.css">
</head>

<body class="w3-light-grey">
  <%- include(process.cwd() +"/views/common/menu.html") %>
    <%- include(process.cwd() +"/views/common/header.html") %>
      <div class="container-md">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
              <% if (viewStatus==="expert" ) { %>
                  <li class="breadcrumb-item text-primary" id="noExpert">No Expert</li>
                  <li class="breadcrumb-item text-muted" id="expert" >Expert</li>
              <% }else{ %>
                  <li class="breadcrumb-item text-muted" id="noExpert">No Expert</li>
                  <li class="breadcrumb-item text-primary" id="expert">Expert</li>
              <% } %>
          </ol>
        </nav>



        <form action="/imputation" method="post">

          <label for="db-list" class="form-label fs-5">Select a database: </label>
          <select class="form-select mb-3 form-control text-uppercase" aria-label="Default select example" name="db_selected">
            <% Object.entries(db_list).forEach(function(entry){ const [key, value]=entry%>
              <% if ( typeof db_infos !=='undefined' && db_infos.name == value.name ){%> 
                <option value="<%- key %>" name="<%- key %>" class="text-uppercase" selected>
                  <%- value.name %>
                </option>
              <% } else {%>
                <option value="<%- key %>" name="<%- key %>" class="text-uppercase">
                  <%- value.name %>
                </option>
              <% } %> 
            <% }) %>
          </select>

          <input type="hidden" class="form-control" name="viewStatus" value="noExpert">
          <button type="submit" class="btn btn-primary mb-3">Submit</button>

        </form>

        <% if (typeof db_infos !=='undefined' ) { %>

          <form action="/imputation/result" method="post">
            <div class="card mb-5" id="detail">
              <div class="card-body">
                <h5 class="card-title">Database Infos</h5>
                <% Object.entries(db_infos).forEach(function(entry){ const [key, value]=entry%>
                  <div class="row">
                    <div class="col text-uppercase fw-bold float-end " value="<%- key %>">
                      <%- key %>
                    </div>
                    <div class="col" value="<%- value %>">
                      <%- value %>
                    </div>
                  </div>
                <% }) %>
              </div>
            </div>

            <% if (typeof db_schema !=='undefined' ) { %>
              <p class="fs-5">Select attributes to complete: </p>
              <p name="hints">You can analyse your data with respect to these axis.</p>

              <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                  <% Object.entries(db_schema).forEach(([dim_name, dim_detail], index)=>{ %>
                      <% if (dim_name !="Fact" ) { %>
                          <% if (index == 0) { %>
                            <button class="nav-link active text-uppercase" id="nav-<%- dim_name%>-tab" data-bs-toggle="tab"
                              data-bs-target="#nav-<%- dim_name%>" type="button" role="tab" aria-controls="#nav-<%- dim_name%>"
                              aria-selected="true">
                              <%- dim_name %>
                            </button>
                          <% } else { %>
                            <button class="nav-link text-uppercase" id="nav-<%- dim_name%>-tab" data-bs-toggle="tab"
                              data-bs-target="#nav-<%- dim_name%>" type="button" role="tab"
                              aria-controls="#nav-<%- dim_name%>" aria-selected="false">
                              <%- dim_name %>
                            </button>
                          <% } %> 
                      <% } %>
                  <% }) %>
                </div>
              </nav>

              <div class="overflow-scroll mb-3" style="height:480px ;">
                <div class="tab-content" id="nav-tabContent">
                  <% Object.entries(db_schema).forEach(([dim_name, dim_detail], index)=>{
                      if(dim_name != "Fact") {
                        if (index == 0) { %>
                          <div class="tab-pane fade show active" id="nav-<%- dim_name%>" role="tabpanel"
                              aria-labelledby="nav-<%- dim_name%>-tab" tabindex="0">
                        <% } else { %>
                          <div class="tab-pane fade" id="nav-<%- dim_name%>" role="tabpanel"
                              aria-labelledby="nav-<%- dim_name%>-tab" tabindex="0">
                        <% } %>
                            <table class="table table-hover table-responsive">
                              <tr>
                                <th scope="col" style="width: 20%" name="noExpert">Axis</th>
                                <th scope="col" style="width: 20%; display: none;" name="expert">Dimension</th>
                                <td scope="row" class="text-uppercase fw-bold">
                                  <%- dim_name %>
                                </td>
                              </tr>
                                <% Object.entries(dim_detail).forEach(function(property){ 
                                  const [proper_name,proper_detail]=property%>
                                  <% if (proper_name=="Hierarchy" && proper_detail !="None" ) { %>
                                    <% Object.entries(proper_detail).forEach(([hie_name, hie_detail], index)=>{%>
                                      <tr name="hierarchy">
                                        <th scope="col" name="noExpert">
                                          Analysis Vision <%- index+1 %>
                                            <span data-descr="In this axis, you have following analysis visions.">
                                              <svg width="28px" height="28px" viewBox="0 0 50 50"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                  d="M25 42c-9.4 0-17-7.6-17-17S15.6 8 25 8s17 7.6 17 17-7.6 17-17 17zm0-32c-8.3 0-15 6.7-15 15s6.7 15 15 15 15-6.7 15-15-6.7-15-15-15z" />
                                                <path
                                                  d="M19.8 19.6c.3-.8.6-1.4 1.2-1.9.5-.5 1.1-.9 1.9-1.2s1.6-.4 2.5-.4c.7 0 1.4.1 2 .3.6.2 1.2.5 1.7.9s.9.9 1.1 1.5c.3.6.4 1.3.4 2 0 1-.2 1.8-.6 2.5s-1 1.3-1.6 2l-1.3 1.3c-.3.3-.6.6-.7.9-.2.3-.3.7-.3 1.1-.1.4-.1.7-.1 1.5h-1.6c0-.8 0-1.1.1-1.7.1-.5.3-1 .5-1.5.2-.4.5-.8.9-1.2.4-.4.9-.8 1.4-1.4.5-.5.9-1 1.2-1.5s.5-1.2.5-1.8c0-.5-.1-1-.3-1.4-.2-.4-.5-.8-.8-1.1-.3-.3-.7-.5-1.2-.7-.5-.2-.9-.3-1.4-.3-.7 0-1.3.1-1.8.4-.5.2-1 .6-1.3 1-.3.4-.6.9-.8 1.5s-.4.9-.4 1.6h-1.6c0-.9.1-1.6.4-2.4zM26 32v2h-2v-2h2z" />
                                              </svg>
                                            </span>
                                        </th>
                                        <th scope="col" name="expert" style="display: none;">Hierarchy <%- index+1 %>
                                        </th>
                                        <td class="text-uppercase">
                                          <div class="row justify-content-between">
                                            <div class="col-4">
                                              <%- hie_name%>
                                            </div>
                                            <div class="col-4">
                                              <svg width="20px" height="20px" viewBox="0 0 20 20"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path fill="#555" fill-rule="evenodd"
                                                  d="M7.05307007,2.15808105 L14.2962587,9.41418482 C14.4320862,9.5496827 14.5,9.71077067 14.5,9.89744874 C14.5,10.0841268 14.4320862,10.2497803 14.2962587,10.3944092 C11.6760845,12.9498393 9.15095523,15.4168071 6.72087106,17.7953128 C6.5962677,17.912323 6.09560574,18.2032928 5.70989407,17.7705688 C5.3241824,17.3378448 5.55848694,16.9602509 5.70989407,16.8045692 C7.97174895,14.594209 10.3279004,12.2918355 12.7783485,9.89744874 L6.03100586,3.13816833 C5.78524099,2.79925826 5.80526899,2.48632792 6.09108986,2.19937732 C6.37691073,1.91242672 6.6975708,1.8986613 7.05307007,2.15808105 Z" />
                                              </svg>
                                            </div>
                                          </div>
                                        </td>
                                      </tr>
                                      <% Object.entries(hie_detail).forEach(function(hie_property){ 
                                        const [hie_key, hie_value]=hie_property%>
                                        <% if (hie_key=="Weak Attributes" ) { %>
                                          <tr name="hieWeakAttributes" style="display: none;">
                                            <th scope="col" name="noExpert">
                                              - Supplementary Information
                                              <span data-descr="The levels contain following supplementary information.">
                                                <svg width="28px" height="28px" viewBox="0 0 50 50"
                                                  xmlns="http://www.w3.org/2000/svg">
                                                  <path
                                                    d="M25 42c-9.4 0-17-7.6-17-17S15.6 8 25 8s17 7.6 17 17-7.6 17-17 17zm0-32c-8.3 0-15 6.7-15 15s6.7 15 15 15 15-6.7 15-15-6.7-15-15-15z" />
                                                  <path
                                                    d="M19.8 19.6c.3-.8.6-1.4 1.2-1.9.5-.5 1.1-.9 1.9-1.2s1.6-.4 2.5-.4c.7 0 1.4.1 2 .3.6.2 1.2.5 1.7.9s.9.9 1.1 1.5c.3.6.4 1.3.4 2 0 1-.2 1.8-.6 2.5s-1 1.3-1.6 2l-1.3 1.3c-.3.3-.6.6-.7.9-.2.3-.3.7-.3 1.1-.1.4-.1.7-.1 1.5h-1.6c0-.8 0-1.1.1-1.7.1-.5.3-1 .5-1.5.2-.4.5-.8.9-1.2.4-.4.9-.8 1.4-1.4.5-.5.9-1 1.2-1.5s.5-1.2.5-1.8c0-.5-.1-1-.3-1.4-.2-.4-.5-.8-.8-1.1-.3-.3-.7-.5-1.2-.7-.5-.2-.9-.3-1.4-.3-.7 0-1.3.1-1.8.4-.5.2-1 .6-1.3 1-.3.4-.6.9-.8 1.5s-.4.9-.4 1.6h-1.6c0-.9.1-1.6.4-2.4zM26 32v2h-2v-2h2z" />
                                                </svg>
                                              </span>
                                            </th>
                                            <th scope="col" name="expert" style="display: none;">- <%- hie_key%>
                                            </th>
                                            <td class="text-uppercase">
                                              <% Object.entries(hie_value).forEach(function(weak){ const [key,
                                                weak_attri]=weak%>
                                                <%- key +": " + weak_attri%><br>
                                            <% }) %>
                                          </td>
                                        </tr>
                                      <% } else {%>
                                          <tr name=" hieParameter" style="display: none;">
                                            <th scope="col" name="expert" style="display: none;">- <%- hie_key%>s</th>
                                            <th scope="col" name="noExpert">
                                              - Analysis Levels
                                              <span data-descr="In this vision, you have following analysis levels.">
                                                <svg width="28px" height="28px" viewBox="0 0 50 50"
                                                  xmlns="http://www.w3.org/2000/svg">
                                                  <path
                                                    d="M25 42c-9.4 0-17-7.6-17-17S15.6 8 25 8s17 7.6 17 17-7.6 17-17 17zm0-32c-8.3 0-15 6.7-15 15s6.7 15 15 15 15-6.7 15-15-6.7-15-15-15z" />
                                                  <path
                                                    d="M19.8 19.6c.3-.8.6-1.4 1.2-1.9.5-.5 1.1-.9 1.9-1.2s1.6-.4 2.5-.4c.7 0 1.4.1 2 .3.6.2 1.2.5 1.7.9s.9.9 1.1 1.5c.3.6.4 1.3.4 2 0 1-.2 1.8-.6 2.5s-1 1.3-1.6 2l-1.3 1.3c-.3.3-.6.6-.7.9-.2.3-.3.7-.3 1.1-.1.4-.1.7-.1 1.5h-1.6c0-.8 0-1.1.1-1.7.1-.5.3-1 .5-1.5.2-.4.5-.8.9-1.2.4-.4.9-.8 1.4-1.4.5-.5.9-1 1.2-1.5s.5-1.2.5-1.8c0-.5-.1-1-.3-1.4-.2-.4-.5-.8-.8-1.1-.3-.3-.7-.5-1.2-.7-.5-.2-.9-.3-1.4-.3-.7 0-1.3.1-1.8.4-.5.2-1 .6-1.3 1-.3.4-.6.9-.8 1.5s-.4.9-.4 1.6h-1.6c0-.9.1-1.6.4-2.4zM26 32v2h-2v-2h2z" />
                                                </svg>
                                              </span>
                                            </th>
                                            <td class="text-uppercase">
                                              <%- hie_value%>
                                            </td>
                                          </tr>
                                          <% } %>
                                      <% }) %>
                                    <% }) %>
                                  <% } else if (proper_name=="Missing" ) { %>
                                          <tr name="missing">
                                            <th scope="col">
                                              <%- proper_name%> Attributes </br>(Missing Number)
                                            </th>
                                            <td class="text-uppercase">
                                              <% Object.entries(proper_detail).forEach(function(missing){ const [attri,
                                                nb]=missing%>
                                                <div class="form-check">
                                                  <%if (nb===0) {%>
                                                    <input class="form-check-input" type="checkbox" value="<%- attri%>"
                                                      id="flexCheckDefault<%- attri%>" name="colSelected" disabled>
                                                    <label class="form-check-label" for="flexCheckDefault<%- attri%>"
                                                      disabled>
                                                      <%- attri +": " + nb%>
                                                    </label>
                                                  <% } else { %> 
                                                      <input class=" form-check-input" type="checkbox"
                                                        value="<%- dim_name%>%<%- attri%>%<%- nb%>"
                                                        id="flexCheckDefault<%- attri%>" name="colSelected">
                                                      <label class="form-check-label"
                                                          for="flexCheckDefault<%- attri%>">
                                                          <%- attri +": " + nb%>
                                                      </label>
                                                  <% } %>
                                                </div>
                                              <% }) %>
                                            </td>
                                          </tr>
                                  <% } else if  (proper_name == "Total Record Number") {%>
                                          <tr name="total">
                                            <th scope="col">Total Record Number</th>
                                            <td class="text-uppercase">
                                              <%- proper_detail%>
                                            </td>
                                          </tr>
                                  <% } else if  (proper_name == "Attributes"){%>
                                          <tr name="attributes">
                                            <th scope="col">
                                              <%- proper_name%>
                                            </th>
                                            <td class="text-uppercase">
                                              <%- proper_detail%>
                                            </td>
                                          </tr>
                                  <% } %>
                                <% }) %>               
                            </table>
                          </div>
                      <% } %>
                  <% }) %>
                </div>
              </div>

            <% } %>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
              id="next">
              Complete
            </button>

            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
              aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="test">
                    <div id="information"></div>
                    <div>
                      <input type="hidden" class="form-control" name="viewStatus"  value="noExpert">
                      <select class="form-select form-select-md mb-3" aria-label=".form-select-lg example" name="noExpert" id="algo_noExpert">
                        <option value="hie" >Complete with exact values</option>
                        <option value="olapknn">Complete as many values as possible</option>
                      </select>
                      <select class="form-select form-select-md mb-3" aria-label=".form-select-lg example"  name="expert" style="display: none;" id="algo_expert">
                        <option value="hie" >Hierarchical imputation</option>
                        <option value="olapknn" >Hie-OLAPKNN</option>
                      </select>
                    </div>
                    <div id="complement" style="display: none;">
                      <div class="mb-3 row">
                        <label for="k" class="col-sm-5 col-form-label">K:</label>
                        <div class="col-sm-5">
                          <input type="text" class="form-control" id="k" name="kvalue">
                        </div>
                      </div>
                      <div class="mb-3 row">
                        <label for="weight" class="col-sm-5 col-form-label">Hierarchy level weight:</label>
                        <div class="col-sm-5">
                          <select class="form-select form-select-md mb-3" aria-label=".form-select-lg example" name="weight">
                            <option value="wc">wc</option>
                            <option value="wi">wi</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="submit" class="btn btn-primary">Yes</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        <% } %>    
      </div>

      <%- include(process.cwd() +"/views/common/footer.html") %>
      <script>
        $(document).ready(function () {
          

          //update modal
          $("#next").click(function () {
            var allVals = [];
            $("#information").html("");
            $("#information").append("<p>The missing values in the following attributes will be completed :</p>" +
              '<table class="table" style = "width: 80%">' +
                '<thead>' +
                  '<tr>' +
                    '<th scope="col" style="width:10%"></th>' +
                    '<th scope="col" style="width:45%">Dimension</th>' +
                    '<th scope="col" style="width:45%">Attributes</th>' +
                  '</tr>' +
                '</thead>')
            nb = 1;
            $('input:checkbox[name=colSelected]:checked').each(function () {
              allVals.push($(this).val());
              $("#information").append('<table class="table" style="width: 80%">' +
                                          '<tr>' +
                                            '<th style="width:10%">' + nb + '</th>' +
                                            '<td class="text-uppercase" style="width:45%">' + 
                                              $(this).val().split("%")[0] + 
                                            '</td>' + 
                                            '<td class="width:50% text-uppercase">' + $(this).val().split("%")[1] + '</td>' + 
                                          '</tr>' +
                                        '</table>')
              nb += 1;
            })
            $("#information").append('<p class="fs-5"></p>')
          })
          $("#algo_expert").click(function(){
            if ($("#algo_expert option:selected").text() == "Hie-OLAPKNN"){
              $("#complement").show()
            } else {
              $("#complement").hide()
            }
          })

          // no expert version
          $("#noExpert").click(function () {
            if ($("#noExpert").hasClass("text-primary")) {
              $("#noExpert").toggleClass("text-primary")
              $("#noExpert").addClass("text-muted")
              $("#expert").removeClass("text-muted")
              $("#expert").addClass("text-primary")
              $('th[name=expert]').hide()
              $('th[name=noExpert]').show()
              $('select[name=noExpert]').show()
              $('select[name=expert]').hide()
              $("p[name*='hints']").show()
              $("input[name=viewStatus]").val("noExpert")
            }
          })

          // expert version
          $("#expert").click(function () {
            if ($("#expert").hasClass("text-primary")) {
              $("#expert").removeClass("text-primary")
              $("#expert").addClass("text-muted")
              $("#noExpert").removeClass("text-muted")
              $("#noExpert").addClass("text-primary")
              $("p[name*='hints']").hide()
              $('th[name=noExpert]').hide()
              $('th[name=expert]').show()
              $('select[name=noExpert]').hide()
              $('select[name=expert]').show()
              $("input[name=viewStatus]").val("expert")
            }
          })

          
          if ( $("#expert").hasClass("text-muted") ){
            $("p[name*='hints']").hide()
            $('th[name=noExpert]').hide()
            $('th[name=expert]').show()
            $('select[name=noExpert]').hide()
            $('select[name=expert]').show()
            $("input[name=viewStatus]").val("expert")
          }

          $("tr[name='hierarchy']").click(function () {
            // $("tr[name*='Attributes']").toggle()
            // $("tr[name*='meter']").toggle()
            $(this).next().toggle()
            $(this).next().addClass("opencss")
            $(this).next().next().toggle()
            $(this).next().next().addClass("opencss")
            var icon = $(this).children().last().children().children().last().children()
            if (icon.hasClass("rotated")) {
              icon.removeClass("rotated")
            } else {
              icon.addClass("rotated")
            }

          })

        })
      </script>

</body>

</html>